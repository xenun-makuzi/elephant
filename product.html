<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title id="pageTitle">Product ‚Äî Nassalab</title>
  <meta name="description" content="Product detail page ‚Äî Nassalab" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
  <style>
    :root{
      --primary:#0A66CC; --bg:#f6fbff; --card:#fff; --muted:#6b7280; --text:#0b1220; --container:1000px;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:"Inter",system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial;background:var(--bg);color:var(--text); -webkit-font-smoothing: antialiased;}
    a{color:inherit; text-decoration: none;}

    /* Header Styles */
    header{
      position:sticky;
      top:0;
      background:#fff;
      border-bottom:1px solid rgba(0,0,0,.05);
      z-index:999;
      padding:10px 0;
    }
    .nav-inner{
      max-width:1180px; /* Use standard container size for header */
      margin:auto;
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding:0 20px;
      gap:12px;
    }
    .logo{
      width:48px;height:48px;border-radius:10px;
      background:var(--primary);
      display:flex;align-items:center;justify-content:center;
      font-weight:700;color:#fff;font-size:20px;
    }
    nav.main a{
      padding:8px 12px;
      font-weight:600;
      color:var(--muted);
    }
    .cart-btn{
      position:relative;
      background:#fff;
      border:1px solid #dce9f9;
      padding:8px 10px;
      border-radius:10px;
      cursor:pointer;
    }
    .cart-badge{
      position:absolute;
      top:-6px;
      right:-6px;
      background:var(--primary);
      color:#fff;
      padding:4px 7px;
      border-radius:999px;
      font-size:12px;
      min-width:18px;
      text-align:center;
    }

    /* Main Content Styles */
    main{ padding: 20px; }
    .container{max-width:var(--container);margin:28px auto;padding:18px}
    .backlink{margin-bottom:12px;display:inline-block;color:var(--muted)}
    .layout{display:grid;grid-template-columns:1fr 380px;gap:20px}
    .gallery{background:var(--card);border-radius:12px;padding:16px;box-shadow:0 10px 30px rgba(5,12,30,0.06)}
    .main-image{width:100%;height:520px;border-radius:10px;overflow:hidden;background:#f5f7fb;display:flex;align-items:center;justify-content:center}
    .main-image img{max-width:100%;max-height:100%;object-fit:contain;display:block}
    .thumbs{display:flex;gap:8px;margin-top:12px;justify-content:flex-start;flex-wrap:wrap}
    .thumbs img{width:92px;height:72px;object-fit:cover;border-radius:8px;cursor:pointer;border:2px solid transparent}
    .thumbs img.active{border-color:var(--primary)}
    aside.meta{background:var(--card);border-radius:12px;padding:18px;box-shadow:0 10px 30px rgba(5,12,30,0.06)}
    .meta h1{font-size:20px;margin:0 0 8px 0}
    .muted{color:var(--muted)}
    .price{font-weight:800;color:var(--primary);font-size:20px;margin-top:8px}
    .desc{margin-top:12px;line-height:1.5;color:#22303a}
    .btn-add{margin-top:16px;background:var(--primary);color:#fff;padding:10px 14px;border:0;border-radius:10px;cursor:pointer;font-weight:700}
    .similar{margin-top:18px}
    .similar-grid{display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-top:8px}
    .similar-grid a{display:flex;gap:8px;align-items:center;padding:8px;background:#fff;border-radius:8px;text-decoration:none;color:var(--text);box-shadow:0 6px 18px rgba(5,12,30,0.04)}
    .similar-grid img{width:64px;height:48px;object-fit:cover;border-radius:6px}

    /* Footer Styles */
    footer{
      margin-top:40px;
      background:#0A66CC;
      color:#fff;
      padding:30px 0;
    }
    footer .footer-row{
      max-width:1180px; /* Use standard container size for footer */
      margin:auto;
      display:flex;
      flex-wrap:wrap;
      gap:20px;
      justify-content:space-between;
      padding: 0 20px;
    }
    footer a{color:#fff;font-weight:600;}

    @media(max-width:900px){ .layout{grid-template-columns:1fr} .main-image{height:320px} .meta{order:2} }
    @media(max-width:640px){ .nav-inner, footer .footer-row { padding: 0 10px; } }
  </style>
</head>
<body>

<header>
  <div class="nav-inner">
    <div style="display:flex;align-items:center;gap:14px">
      <div class="logo">NL</div>
      <div>
        <div style="font-weight:700;font-size:18px">Nassalab</div>
        <div style="color:var(--muted);font-size:12px">Premium Anabolics</div>
      </div>
    </div>

    <nav class="main" aria-label="Main navigation">
      <a href="index.html">Home</a>
      <a href="store.html">Store</a>
      <a href="contact.html">Contact</a>
    </nav>

    <div>
      <button class="cart-btn" onclick="location.href='cart.html'" aria-label="View cart">
        üõí <span id="cartCount" class="cart-badge">0</span>
      </button>
    </div>
  </div>
</header>

<main>
  <div class="container" id="app">
    <a href="index.html" class="backlink">‚Üê Back to home</a>

    <div id="content" class="layout" aria-live="polite">
      <div class="gallery" id="galleryWrap" aria-label="Product images">
        <div class="main-image" id="mainImageWrap" role="img" aria-label="Product image">
          <img id="mainImage" alt="Product image">
        </div>
        <div class="thumbs" id="thumbs"></div>
      </div>

      <aside class="meta" id="meta">
        <div id="metaHead">
          <h1 id="productName">Product name</h1>
          <div id="productCategory" class="muted"></div>
          <div id="productPrice" class="price" aria-live="polite"></div>
        </div>

        <div class="desc" id="productDesc"></div>
        <button id="addToCart" class="btn-add">Add to cart</button>

        <div class="similar" id="similarWrap" aria-label="Similar products">
          <strong>Similar products</strong>
          <div class="similar-grid" id="similarGrid"></div>
        </div>
      </aside>
    </div>
  </div>
</main>

<footer>
  <div class="footer-row">
    <div>
      <h3>Nassalab</h3>
      <p>Premium pharmaceutical-grade anabolics.</p>
    </div>
    <div>
      <a href="index.html">Home</a><br>
      <a href="store.html">Store</a><br>
      <a href="contact.html">Contact</a>
    </div>
    <div>
      <p>&copy; <span id="year"></span> Nassalab. All rights reserved.</p>
    </div>
  </div>
</footer>

<script>
/* ---------------------------
  Utilities
----------------------------*/
function qs(q){ return document.querySelector(q); }
function qsa(q){ return Array.from(document.querySelectorAll(q)); }
function getQueryParam(name){
  const params = new URLSearchParams(location.search);
  return params.get(name);
}
function slugify(s){ return String(s||'').toLowerCase().replace(/\s+/g,'-').replace(/[^\w\-]+/g,'').replace(/\-\-+/g,'-').replace(/^-+|-+$/g,''); }
function parsePriceValue(raw){
  if(typeof raw === 'number' && Number.isFinite(raw)) return Number(raw);
  if(!raw) return 0;
  const s = String(raw).trim();
  const cleaned = s.replace(/[^0-9\.\-]/g,'').replace(/,+/g,'');
  const v = parseFloat(cleaned);
  return Number.isFinite(v) ? v : 0;
}
function detectCurrency(raw){
  if(!raw) return 'USD';
  if(String(raw).includes('‚Ç¨')) return 'EUR';
  if(String(raw).includes('¬£')) return 'GBP';
  return 'USD';
}
function formatCurrency(n, currency='USD'){
  const val = Number(n||0).toFixed(2);
  if(currency === 'EUR') return '‚Ç¨' + val;
  if(currency === 'GBP') return '¬£' + val;
  return '$' + val;
}

/* ---------------------------
  Cart Integration Functions (NEW)
----------------------------*/
const CART_KEY = 'nassalab_cart_v1';
const cartCountEl = qs('#cartCount');

// Update the cart badge displayed in the header
function syncCartCountFromStorage(){
  const raw = localStorage.getItem(CART_KEY);
  let cart = {};
  try {
      const parsedCart = JSON.parse(raw);
      // Handles both {items: {id: qty}} and legacy {id: qty} formats
      cart = (parsedCart && parsedCart.items) ? parsedCart.items : parsedCart || {};
  } catch (e) {
      cart = {};
  }
  const count = Object.values(cart).reduce((s,n)=>s + (Number(n)||0), 0);
  cartCountEl.textContent = count;
}

// Add item to cart and store in localStorage
function addToCart(product){
  const raw = localStorage.getItem(CART_KEY);
  let cartData;
  try {
    const parsedCart = JSON.parse(raw);
    if (parsedCart && parsedCart.items) {
      cartData = parsedCart; // Use structured cart
    } else {
      // Handle legacy/simple cart format: {id: qty}
      cartData = { items: parsedCart || {}, isShippingRequired: true, promoCode: null };
    }
  } catch (e) {
    cartData = { items: {}, isShippingRequired: true, promoCode: null };
  }
  
  const id = String(product.id || product.slug || product.sku);
  cartData.items[id] = (cartData.items[id] || 0) + 1;
  
  localStorage.setItem(CART_KEY, JSON.stringify(cartData));
  syncCartCountFromStorage();
}

/* ---------------------------
  State & DOM refs
----------------------------*/
const slug = getQueryParam('slug') || getQueryParam('id') || location.hash.replace('#','').split('=')[1];
const mainImage = qs('#mainImage');
const thumbsWrap = qs('#thumbs');
const productName = qs('#productName');
const productCategory = qs('#productCategory');
const productPrice = qs('#productPrice');
const productDesc = qs('#productDesc');
const addToCartBtn = qs('#addToCart');
const similarGrid = qs('#similarGrid');
const yearEl = qs('#year');
if(yearEl) yearEl.textContent = new Date().getFullYear(); // Footer year

let PRODUCTS = [];
let CURRENT_PRODUCT = null;
let images = []; // array of image URLs for current product
let currentIndex = 0;


/* ---------------------------
  Load products.json, find product by slug, render
----------------------------*/
async function loadAndRender(){
  try{
    const res = await fetch('./products.json', {cache:'no-store'});
    PRODUCTS = await res.json();

    // normalize each product (price numeric, images array)
    PRODUCTS = PRODUCTS.map(p=>{
      p._price = parsePriceValue(p.price ?? p._price ?? 0);
      // normalize images: support array OR {front:..., back:...}
      if(!p.images) p.images = [];
      else if(!Array.isArray(p.images)){
        if(p.images.front || p.images.back){
          const arr = [];
          if(p.images.front) arr.push(p.images.front);
          if(p.images.back) arr.push(p.images.back);
          p.images = arr;
        } else {
          p.images = [String(p.images)];
        }
      }
      if(!p.slug && p.name) p.slug = slugify(p.name);
      return p;
    });

    // find product by slug
    if(!slug){ showError('No product specified.'); return; }
    const target = PRODUCTS.find(p => p.slug === slug || String(p.id) === slug);
    if(!target){ showError('Product not found.'); return; }
    CURRENT_PRODUCT = target;
    images = Array.isArray(target.images) ? target.images.slice() : [];

    // ensure front-first behavior:
    if(images.length === 0 && target.images && typeof target.images === 'object'){
      if(target.images.front) images.push(target.images.front);
      if(target.images.back) images.push(target.images.back);
    }

    // If there are no images at all, use a placeholder
    if(images.length === 0) images = ['placeholder.jpg'];

    // Update page title
    qs('#pageTitle').textContent = CURRENT_PRODUCT.name + ' ‚Äî Nassalab';

    // fill main and thumbnails
    renderGallery();
    renderMeta();
    renderSimilar();
    injectJsonLd(CURRENT_PRODUCT);

    // Add to cart handler (UPDATED TO USE NEW FUNCTION)
    addToCartBtn.addEventListener('click', ()=>{
      addToCart(CURRENT_PRODUCT);
      addToCartBtn.textContent = 'Added';
      setTimeout(()=> addToCartBtn.textContent = 'Add to cart', 900);
    });

    syncCartCountFromStorage(); // Update the cart badge on page load
  } catch(err){
    console.error(err);
    showError('Failed to load product data.');
  }
}

/* ---------------------------
  Render gallery: front default and thumbs
----------------------------*/
function renderGallery(){
  currentIndex = 0;
  setMainImage(images[currentIndex]);
  thumbsWrap.innerHTML = '';
  images.forEach((src, i)=>{
    const img = document.createElement('img');
    img.src = src;
    img.alt = (CURRENT_PRODUCT.name || 'Product') + ' ' + (i+1);
    img.tabIndex = 0;
    if(i === currentIndex) img.classList.add('active');
    img.addEventListener('click', ()=> switchImage(i));
    img.addEventListener('keydown', (e)=>{ if(e.key === 'Enter' || e.key === ' ') switchImage(i); });
    thumbsWrap.appendChild(img);
  });

  // swipe support on main image (touch)
  let startX = null;
  const wrap = document.getElementById('mainImageWrap');
  wrap.addEventListener('touchstart', e => { startX = e.touches[0].clientX; }, {passive:true});
  wrap.addEventListener('touchend', e => {
    if(startX == null) return;
    const endX = e.changedTouches[0].clientX;
    const diff = endX - startX;
    if(Math.abs(diff) > 40){
      if(diff < 0) nextImage(); else prevImage();
    }
    startX = null;
  });
}

/* set the main image src and ARIA label */
function setMainImage(src){
  mainImage.src = src;
  mainImage.alt = (CURRENT_PRODUCT.name || 'Product') + ' image';
  // update active thumb border
  qsa('#thumbs img').forEach((t, idx) => t.classList.toggle('active', idx === currentIndex));
}

/* switch image by index */
function switchImage(i){
  if(i < 0 || i >= images.length) return;
  currentIndex = i;
  setMainImage(images[currentIndex]);
}

/* next / prev */
function nextImage(){ switchImage((currentIndex + 1) % images.length); }
function prevImage(){ switchImage((currentIndex - 1 + images.length) % images.length); }

/* ---------------------------
  Render meta (title, price, desc)
----------------------------*/
function renderMeta(){
  productName.textContent = CURRENT_PRODUCT.name || '';
  productCategory.textContent = CURRENT_PRODUCT.category || '';
  // determine currency from raw price string if present
  const currency = detectCurrency(CURRENT_PRODUCT.price || '');
  productPrice.textContent = formatCurrency(CURRENT_PRODUCT._price || 0, currency);
  productDesc.textContent = CURRENT_PRODUCT.description || CURRENT_PRODUCT.short_description || '';
}

/* ---------------------------
  Similar products grid
----------------------------*/
function renderSimilar(){
  similarGrid.innerHTML = '';
  const sim = PRODUCTS.filter(p => p.category === CURRENT_PRODUCT.category && p.slug !== CURRENT_PRODUCT.slug).slice(0,4);
  sim.forEach(s => {
    const a = document.createElement('a');
    a.href = 'product.html?slug=' + encodeURIComponent(s.slug);
    // Ensure image property access is safe
    const imgUrl = (s.images && Array.isArray(s.images) && s.images[0]) || 'placeholder.jpg';
    a.innerHTML = `<img src="${imgUrl}" alt="${s.name}"><div><div style="font-weight:700">${s.name}</div><div style="color:var(--muted)">${formatCurrency(s._price, detectCurrency(s.price||''))}</div></div>`;
    similarGrid.appendChild(a);
  });
}

/* ---------------------------
  JSON-LD for SEO (product)
----------------------------*/
function injectJsonLd(p){
  try{
    const priceCurr = detectCurrency(p.price || '');
    const ld = {
      "@context":"https://schema.org",
      "@type":"Product",
      "name": p.name,
      "image": p.images || [],
      "description": p.short_description || p.description || '',
      "sku": p.slug || (p.id? String(p.id) : ''),
      "brand": {"@type":"Brand","name":"Sama Labs"},
      "offers": {
        "@type":"Offer",
        "url": location.href,
        "priceCurrency": priceCurr,
        "price": String(p._price || parsePriceValue(p.price || 0)),
        "availability": "http://schema.org/InStock"
      }
    };
    const s = document.createElement('script');
    s.type = 'application/ld+json';
    s.text = JSON.stringify(ld);
    document.head.appendChild(s);
  } catch(e){ console.warn('json-ld failed', e); }
}

/* ---------------------------
  Helpers & errors
----------------------------*/
function showError(msg){
  const content = qs('#content');
  content.innerHTML = `<div style="padding:28px;background:#fff;border-radius:10px;color:#b00">${msg}</div>`;
}

/* ---------------------------
  Kick off
----------------------------*/
loadAndRender();
</script>
</body>
</html>
